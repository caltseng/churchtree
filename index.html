<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ChurchTree - Presbyterian Lineage (Phase 0)</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.css"
  />
  <style>
    :root {
      --bg-1: #f6f1e8;
      --bg-2: #e8efe6;
      --ink: #2b2b2b;
      --muted: #6b6b6b;
      --accent: #9e4d2f;
      --panel: #fffdfa;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Palatino Linotype", "Book Antiqua", Palatino, serif;
      color: var(--ink);
      background:
        linear-gradient(135deg, rgba(255,255,255,0.6), rgba(255,255,255,0.2)),
        radial-gradient(circle at 20% 20%, #f7eadc 0%, transparent 55%),
        radial-gradient(circle at 80% 30%, #e3efe9 0%, transparent 50%),
        linear-gradient(180deg, var(--bg-1), var(--bg-2));
      min-height: 100vh;
    }

    header {
      padding: 22px 24px 10px 24px;
    }

    h1 {
      margin: 0 0 6px 0;
      font-size: 28px;
      letter-spacing: 0.4px;
    }

    p {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }

    #graph-wrap {
      padding: 12px 16px 24px 16px;
    }

    #network {
      width: 100%;
      height: 70vh;
      min-height: 520px;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.6);
      box-shadow: 0 6px 22px rgba(0,0,0,0.08);
    }

    .controls {
      position: absolute;
      top: 16px;
      right: 22px;
      display: flex;
      gap: 8px;
      z-index: 5;
    }

    .control-btn {
      border: 1px solid #cdb7a8;
      background: #fffdfa;
      color: #2b2b2b;
      font-size: 16px;
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    }

    .control-btn:hover {
      border-color: #a87f6b;
      color: #7b3a24;
    }

    .note {
      margin: 10px 16px 0 16px;
      padding: 10px 12px;
      background: var(--panel);
      border: 1px solid #d9c6b8;
      border-radius: 10px;
      font-size: 12.5px;
      color: var(--muted);
    }

    #hover-tip {
      position: fixed;
      display: none;
      max-width: 320px;
      padding: 10px 12px;
      font-size: 13px;
      line-height: 1.35;
      color: #2c2c2c;
      background: #fffdfa;
      border: 1px solid #d9c6b8;
      border-radius: 10px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.12);
      pointer-events: none;
      z-index: 20;
    }

    #hover-tip .title {
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 4px;
    }

    #hover-tip .meta {
      color: var(--muted);
    }

    .vis-tooltip {
      font-family: "Palatino Linotype", "Book Antiqua", Palatino, serif;
      font-size: 13px;
      line-height: 1.35;
      color: #2c2c2c;
      background: #fffdfa;
      border: 1px solid #d9c6b8;
      border-radius: 10px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.12);
      padding: 10px 12px;
      max-width: 320px;
      white-space: normal;
      z-index: 20;
    }

    @media (max-width: 720px) {
      h1 { font-size: 22px; }
      #network { min-height: 420px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>ChurchTree - Presbyterian Lineage</h1>
    <p>Phase 0 static graph. Hover an edge to view split/merge details.</p>
  </header>

  <div id="graph-wrap" style="position: relative;">
    <div class="controls">
      <button class="control-btn" id="zoom-in" aria-label="Zoom in">+</button>
      <button class="control-btn" id="zoom-out" aria-label="Zoom out">−</button>
      <button class="control-btn" id="zoom-reset" aria-label="Reset zoom">Reset</button>
    </div>
    <div id="network"></div>
  </div>

  <div class="note">
    Graph rendered with vis-network (MIT License).
  </div>
  <div id="hover-tip"></div>

  <script src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
  <script>
    function showError(message) {
      const container = document.getElementById("network");
      container.innerHTML = "";
      const div = document.createElement("div");
      div.style.padding = "16px";
      div.style.color = "#9a5a45";
      div.textContent = message;
      container.appendChild(div);
    }

    function buildTooltip(edge, fromNode, toNode) {
      const fromLabel = fromNode && fromNode.short_label ? fromNode.short_label : (fromNode ? fromNode.name : "");
      const toLabel = toNode && toNode.short_label ? toNode.short_label : (toNode ? toNode.name : "");
      const reasons = (edge.reasons || []).join(", ");
      const title = edge.name ? edge.name : `${fromLabel} -> ${toLabel}`;
      return `
        <div class="title">${title}</div>
        <div><em>${edge.type.toUpperCase()}</em> (${edge.year || "unknown"})</div>
        ${edge.description ? `<div>${edge.description}</div>` : ""}
        ${reasons ? `<div class="meta">Reasons: ${reasons}</div>` : ""}
      `;
    }

    function buildNodeTooltip(node) {
      const years = node.start_year ? `${node.start_year}${node.end_year ? `–${node.end_year}` : ""}` : "unknown";
      const distinctives = node.distinctives && node.distinctives.length
        ? node.distinctives.join(", ")
        : "Not yet captured";
      return `
        <div class="title">${node.name}</div>
        <div>${node.short_label || node.name} (${years})</div>
        ${node.region ? `<div class="meta">Region: ${node.region}</div>` : ""}
        ${node.notes ? `<div class="meta">Notes: ${node.notes}</div>` : ""}
        <div class="meta">Theological distinctives: ${distinctives}</div>
      `;
    }

    function renderGraph(data) {
      const nodes = Array.isArray(data.nodes) ? data.nodes : [];
      const edges = Array.isArray(data.edges) ? data.edges : [];

      if (!nodes.length) {
        showError("No data loaded. Check that data/data.js exists and is reachable.");
        return;
      }

      const nodeMap = new Map(nodes.map(n => [n.id, n]));

      const years = nodes
        .map(n => n.start_year)
        .filter(y => typeof y === "number" && !Number.isNaN(y));
      const minYear = years.length ? Math.min.apply(null, years) : 0;
      const maxYear = years.length ? Math.max.apply(null, years) : minYear;
      const yearSpan = Math.max(1, maxYear - minYear);
      const levelStep = 25;

      const visNodes = nodes.map(n => {
        const year = typeof n.start_year === "number" ? n.start_year : minYear;
        const level = Math.round((year - minYear) / levelStep);
        return {
        id: n.id,
        label: n.short_label ? `${n.short_label} (${n.start_year || "?"})` : n.name,
        _tooltip: buildNodeTooltip(n),
        level,
        shape: "box",
        margin: 8,
        font: { size: 14, face: "Palatino Linotype", color: "#2b2b2b", align: "left" },
        color: {
          background: "#fffdf9",
          border: "#4b5a4a",
          highlight: { background: "#fff3e6", border: "#a5422c" }
        }
      };
      });

      const visEdges = edges.map(e => ({
        id: e.id,
        from: e.from_id,
        to: e.to_id,
        label: e.name || "",
        _tooltip: buildTooltip(e, nodeMap.get(e.from_id), nodeMap.get(e.to_id)),
        arrows: "to",
        width: 2,
        color: { color: "#6a776a", highlight: "#a5422c" },
        font: { size: 13, align: "horizontal", color: "#5a5a5a" }
      }));

      const container = document.getElementById("network");
      const dataSet = {
        nodes: new vis.DataSet(visNodes),
        edges: new vis.DataSet(visEdges)
      };

      const options = {
        layout: {
          hierarchical: {
            enabled: true,
            direction: "UD",
            sortMethod: "directed",
            nodeSpacing: 230,
            levelSeparation: 120
          }
        },
        physics: { enabled: false },
        interaction: { hover: true, tooltipDelay: 80, hoverConnectedEdges: true },
        nodes: {
          shape: "box",
          font: { size: 14, face: "Palatino Linotype", align: "left", color: "#2b2b2b" },
          margin: 12
        },
        edges: {
          smooth: false,
          font: { size: 13, align: "horizontal", color: "#5a5a5a" }
        }
      };

      const network = new vis.Network(container, dataSet, options);
      const zoomIn = document.getElementById("zoom-in");
      const zoomOut = document.getElementById("zoom-out");
      const zoomReset = document.getElementById("zoom-reset");
      const zoomStep = 0.15;

      zoomIn.addEventListener("click", () => {
        const scale = network.getScale();
        network.moveTo({ scale: scale + zoomStep });
      });
      zoomOut.addEventListener("click", () => {
        const scale = network.getScale();
        network.moveTo({ scale: Math.max(0.2, scale - zoomStep) });
      });
      zoomReset.addEventListener("click", () => {
        network.fit({ animation: { duration: 200 } });
      });
      const hoverTip = document.getElementById("hover-tip");

      function showTip(html, evt) {
        hoverTip.innerHTML = html;
        hoverTip.style.display = "block";
        hoverTip.style.left = `${evt.event.clientX + 12}px`;
        hoverTip.style.top = `${evt.event.clientY + 12}px`;
      }

      function hideTip() {
        hoverTip.style.display = "none";
      }

      network.on("hoverNode", (evt) => {
        const node = dataSet.nodes.get(evt.node);
        if (node && node._tooltip) showTip(node._tooltip, evt);
      });
      network.on("hoverEdge", (evt) => {
        const edge = dataSet.edges.get(evt.edge);
        if (edge && edge._tooltip) showTip(edge._tooltip, evt);
      });
      network.on("blurNode", hideTip);
      network.on("blurEdge", hideTip);
    }

    const dataScript = document.createElement("script");
    dataScript.src = `data/data.js?v=${Date.now()}`;
    dataScript.onload = () => {
      if (!window.CHURCHTREE_DATA) {
        showError("Loaded data/data.js, but window.CHURCHTREE_DATA is missing.");
        return;
      }
      renderGraph(window.CHURCHTREE_DATA);
    };
    dataScript.onerror = () => {
      const expected = new URL("data/data.js", window.location.href).href;
      showError(`Failed to load data/data.js. Expected at ${expected}`);
    };
    document.head.appendChild(dataScript);
  </script>
</body>
</html>
